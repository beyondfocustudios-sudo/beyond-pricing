(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3173],{276:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>f});var s=a(95155),r=a(12115),l=a(37586),n=a(6191),c=a(35626),i=a(99051),o=a(18085),d=a(95740),m=a(65229),u=a(24033),x=a(20063),h=a(93014);function p(){var e,t,a;let p=(0,x.useSearchParams)(),f=(0,x.useRouter)(),v=(0,h.d)(),y=p.get("id"),[j,b]=(0,r.useState)([]),[g,N]=(0,r.useState)(!0),[k,w]=(0,r.useState)(null),[A,C]=(0,r.useState)(null),[S,_]=(0,r.useState)(!1),[P,T]=(0,r.useState)(""),[E,M]=(0,r.useState)(!1),[z,O]=(0,r.useState)(!1),R=(0,r.useRef)(null),[L,D]=(0,r.useState)(!1),[I,B]=(0,r.useState)([]),[W,q]=(0,r.useState)(!1),[F,H]=(0,r.useState)(""),[V,J]=(0,r.useState)(!1),K=(0,r.useCallback)(async()=>{N(!0),w(null);try{let t=await fetch("/api/conversations",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"list"})});if(t.ok){var e;let a=await t.json();b(null!=(e=a.conversations)?e:[])}else{let e="Erro ao carregar conversas";w(e),v.error(e)}}catch(t){let e="Sem liga\xe7\xe3o — n\xe3o foi poss\xedvel carregar conversas";w(e),v.error(e)}finally{N(!1)}},[v]);(0,r.useEffect)(()=>{K()},[K]);let X=(0,r.useCallback)(async e=>{f.push("/app/inbox?id=".concat(e.id),{scroll:!1}),_(!0);try{let t=await fetch("/api/conversations/".concat(e.id));if(t.ok){let a=await t.json();C(a),await fetch("/api/conversations/".concat(e.id,"/read"),{method:"POST"}),b(t=>t.map(t=>t.id===e.id?{...t,unread_count:0}:t))}else v.error("Erro ao abrir conversa")}catch(e){v.error("Sem liga\xe7\xe3o")}finally{_(!1)}},[f,v]);(0,r.useEffect)(()=>{if(y&&j.length>0&&!A){let e=j.find(e=>e.id===y);e&&X(e)}},[y,j,A,X]),(0,r.useEffect)(()=>{var e;null==(e=R.current)||e.scrollIntoView({behavior:"smooth"})},[null==A?void 0:A.messages]);let Y=async()=>{if(P.trim()&&A){M(!0),T("");try{let e=await fetch("/api/conversations/".concat(A.id,"/messages"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({body:P,from:"team"})});if(e.ok){let t=await e.json();C(e=>{var a;return e?{...e,messages:[...null!=(a=e.messages)?a:[],t]}:e})}else v.error("Erro ao enviar mensagem"),T(P)}catch(e){v.error("Sem liga\xe7\xe3o"),T(P)}finally{M(!1)}}},$=async()=>{if(A){O(!0);try{let e=await fetch("/api/conversations/".concat(A.id,"/suggest"),{method:"POST"});if(e.ok){let t=await e.json();t.suggestion?T(t.suggestion):v.info("Sugest\xe3o IA ainda n\xe3o dispon\xedvel")}}finally{O(!1)}}},Z=e=>{try{let t=new Date(e),a=new Date;if(t.toDateString()===a.toDateString())return t.toLocaleTimeString("pt-PT",{hour:"2-digit",minute:"2-digit"});return t.toLocaleDateString("pt-PT",{day:"2-digit",month:"2-digit"})}catch(e){return""}},G=async()=>{D(!0),H(""),q(!0);try{let t=await fetch("/api/projects");if(t.ok){var e;let a=await t.json();B((null!=(e=a.projects)?e:[]).filter(e=>e.client_id))}else B([])}catch(e){B([])}finally{q(!1)}},Q=async()=>{if(F){J(!0);try{let t=await fetch("/api/conversations?projectId=".concat(F));if(t.ok){let e=await t.json();D(!1),await K();let a={id:e.conversation.id,unread_count:0,updated_at:new Date().toISOString()};X(a),v.success("Conversa criada")}else{var e;let a=await t.json();v.error(null!=(e=a.error)?e:"Erro ao criar conversa")}}catch(e){v.error("Sem liga\xe7\xe3o")}finally{J(!1)}}};return(0,s.jsxs)("div",{className:"h-[calc(100dvh-8rem)] flex gap-4 max-w-5xl mx-auto",children:[(0,s.jsxs)("div",{className:"flex flex-col w-full md:w-80 shrink-0 ".concat(A?"hidden md:flex":"flex"),children:[(0,s.jsxs)("div",{className:"flex items-center gap-3 mb-4",children:[(0,s.jsx)(l.A,{className:"h-5 w-5",style:{color:"var(--accent)"}}),(0,s.jsx)("h1",{className:"text-lg font-bold flex-1",style:{color:"var(--text)"},children:"Inbox"}),(0,s.jsxs)("button",{onClick:G,className:"btn btn-primary btn-sm",title:"Nova conversa",children:[(0,s.jsx)(n.A,{className:"h-4 w-4"}),(0,s.jsx)("span",{className:"hidden sm:inline",children:"Nova"})]})]}),(0,s.jsx)("div",{className:"flex-1 overflow-y-auto space-y-2",children:g?[void 0,void 0,void 0,void 0].map((e,t)=>(0,s.jsx)("div",{className:"card-glass rounded-xl h-16 animate-pulse",style:{background:"var(--surface)"}},t)):k?(0,s.jsxs)("div",{className:"card-glass rounded-xl p-6 text-center space-y-3",children:[(0,s.jsx)("p",{style:{color:"var(--text-2)"},children:k}),(0,s.jsx)("button",{onClick:K,className:"btn btn-secondary btn-sm mx-auto",children:"Tentar novamente"})]}):0===j.length?(0,s.jsxs)("div",{className:"card-glass rounded-xl p-8 text-center space-y-3",children:[(0,s.jsx)(l.A,{className:"h-8 w-8 mx-auto",style:{color:"var(--text-3)"}}),(0,s.jsx)("p",{style:{color:"var(--text-2)"},children:"Sem conversas"}),(0,s.jsxs)("button",{onClick:G,className:"btn btn-primary btn-sm mx-auto",children:[(0,s.jsx)(n.A,{className:"h-4 w-4"}),"Iniciar conversa"]})]}):j.map(e=>{var t;return(0,s.jsxs)("button",{className:"w-full text-left card-glass rounded-xl p-3 space-y-1 transition-all ".concat((null==A?void 0:A.id)===e.id?"ring-1":""),onClick:()=>X(e),children:[(0,s.jsxs)("div",{className:"flex items-start justify-between gap-2",children:[(0,s.jsx)("p",{className:"text-sm font-semibold truncate",style:{color:"var(--text)"},children:null!=(t=e.client_name)?t:"Cliente"}),(0,s.jsxs)("div",{className:"flex items-center gap-1.5 shrink-0",children:[e.unread_count>0&&(0,s.jsx)("span",{className:"text-xs px-1.5 py-0.5 rounded-full font-semibold",style:{background:"var(--accent)",color:"white"},children:e.unread_count}),(0,s.jsx)("span",{className:"text-xs",style:{color:"var(--text-3)"},children:Z(e.updated_at)})]})]}),e.project_name&&(0,s.jsx)("p",{className:"text-xs",style:{color:"var(--accent)"},children:e.project_name}),e.last_message&&(0,s.jsx)("p",{className:"text-xs truncate",style:{color:"var(--text-3)"},children:e.last_message})]},e.id)})})]}),A?(0,s.jsxs)("div",{className:"flex flex-col flex-1 min-w-0 card-glass rounded-xl overflow-hidden",children:[(0,s.jsxs)("div",{className:"flex items-center gap-3 p-4",style:{borderBottom:"1px solid var(--border)"},children:[(0,s.jsx)("button",{className:"btn btn-ghost btn-icon-sm md:hidden",onClick:()=>{C(null),f.push("/app/inbox",{scroll:!1})},children:(0,s.jsx)(c.A,{className:"h-4 w-4"})}),(0,s.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,s.jsx)("p",{className:"font-semibold",style:{color:"var(--text)"},children:null!=(e=A.client_name)?e:"Cliente"}),A.project_name&&(0,s.jsx)("p",{className:"text-xs",style:{color:"var(--accent)"},children:A.project_name})]}),(0,s.jsxs)("div",{className:"flex items-center gap-1",children:[(0,s.jsx)(i.A,{className:"h-2 w-2 fill-current",style:{color:"#22c55e"}}),(0,s.jsx)("span",{className:"text-xs",style:{color:"var(--text-3)"},children:"Online"})]})]}),(0,s.jsxs)("div",{className:"flex-1 overflow-y-auto p-4 space-y-3",children:[S?(0,s.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,s.jsx)("div",{className:"animate-spin h-6 w-6 border-2 rounded-full",style:{borderColor:"var(--accent)",borderTopColor:"transparent"}})}):0===(null!=(t=A.messages)?t:[]).length?(0,s.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,s.jsx)("p",{className:"text-sm",style:{color:"var(--text-3)"},children:"Sem mensagens ainda"})}):(null!=(a=A.messages)?a:[]).map(e=>(0,s.jsx)("div",{className:"flex ".concat("team"===e.from?"justify-end":"justify-start"),children:(0,s.jsxs)("div",{className:"max-w-[70%] rounded-2xl px-4 py-2.5 text-sm",style:"team"===e.from?{background:"var(--accent)",color:"white",borderBottomRightRadius:"4px"}:{background:"var(--surface-2)",color:"var(--text)",borderBottomLeftRadius:"4px"},children:[(0,s.jsx)("p",{className:"whitespace-pre-wrap",children:e.body}),(0,s.jsx)("p",{className:"text-xs mt-1 opacity-70",children:Z(e.created_at)})]})},e.id)),(0,s.jsx)("div",{ref:R})]}),(0,s.jsxs)("div",{className:"p-3 space-y-2",style:{borderTop:"1px solid var(--border)"},children:[(0,s.jsxs)("div",{className:"flex gap-2 items-end",children:[(0,s.jsx)("textarea",{className:"input flex-1 min-h-[44px] max-h-32 resize-y text-sm",placeholder:"Escreve uma mensagem… (Enter para enviar)",value:P,onChange:e=>T(e.target.value),onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),Y())}}),(0,s.jsx)("button",{className:"btn btn-primary btn-icon-sm shrink-0",onClick:Y,disabled:E||!P.trim(),children:(0,s.jsx)(o.A,{className:"h-4 w-4"})})]}),(0,s.jsxs)("button",{className:"btn btn-ghost btn-sm text-xs",onClick:$,disabled:z,children:[(0,s.jsx)(d.A,{className:"h-3.5 w-3.5"}),z?"A gerar…":"Sugerir resposta"]})]})]}):(0,s.jsx)("div",{className:"hidden md:flex flex-1 items-center justify-center card-glass rounded-xl",children:(0,s.jsxs)("div",{className:"text-center space-y-3",children:[(0,s.jsx)(l.A,{className:"h-10 w-10 mx-auto",style:{color:"var(--text-3)"}}),(0,s.jsx)("p",{style:{color:"var(--text-2)"},children:"Seleciona uma conversa"}),(0,s.jsxs)("button",{onClick:G,className:"btn btn-primary btn-sm mx-auto",children:[(0,s.jsx)(n.A,{className:"h-4 w-4"}),"Nova conversa"]})]})}),L&&(0,s.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",style:{background:"rgba(0,0,0,0.5)",backdropFilter:"blur(4px)"},onClick:e=>{e.target===e.currentTarget&&D(!1)},children:(0,s.jsxs)("div",{className:"card rounded-2xl w-full max-w-sm space-y-4",style:{background:"var(--surface)"},children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("p",{className:"font-semibold",style:{color:"var(--text)"},children:"Nova Conversa"}),(0,s.jsx)("button",{className:"btn btn-ghost btn-icon-sm",onClick:()=>D(!1),children:(0,s.jsx)(m.A,{className:"h-4 w-4"})})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"label",children:"Projeto"}),W?(0,s.jsxs)("div",{className:"input flex items-center gap-2",style:{color:"var(--text-3)"},children:[(0,s.jsx)("div",{className:"animate-spin h-4 w-4 border-2 rounded-full",style:{borderColor:"var(--accent)",borderTopColor:"transparent"}}),"A carregar projetos…"]}):(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsxs)("select",{value:F,onChange:e=>H(e.target.value),className:"input w-full appearance-none pr-8",children:[(0,s.jsx)("option",{value:"",children:"Selecionar projeto com cliente…"}),I.map(e=>(0,s.jsxs)("option",{value:e.id,children:[e.project_name,e.client_name?" — ".concat(e.client_name):""]},e.id))]}),(0,s.jsx)(u.A,{className:"absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 pointer-events-none",style:{color:"var(--text-3)"}})]}),!W&&0===I.length&&(0,s.jsx)("p",{className:"text-xs mt-1",style:{color:"var(--text-3)"},children:"Nenhum projeto com cliente associado. Vai a Projetos → Brief para associar um cliente."})]}),(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsx)("button",{className:"btn btn-secondary flex-1",onClick:()=>D(!1),children:"Cancelar"}),(0,s.jsx)("button",{className:"btn btn-primary flex-1",disabled:!F||V,onClick:Q,children:V?"A criar…":"Criar conversa"})]})]})})]})}function f(){return(0,s.jsx)(r.Suspense,{fallback:(0,s.jsx)("div",{className:"flex items-center justify-center h-64",children:(0,s.jsx)("div",{className:"animate-spin h-8 w-8 border-2 rounded-full",style:{borderColor:"var(--accent)",borderTopColor:"transparent"}})}),children:(0,s.jsx)(p,{})})}},6191:(e,t,a)=>{"use strict";a.d(t,{A:()=>s});let s=(0,a(71847).A)("Plus",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]])},18085:(e,t,a)=>{"use strict";a.d(t,{A:()=>s});let s=(0,a(71847).A)("Send",[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]])},20063:(e,t,a)=>{"use strict";var s=a(47260);a.o(s,"useParams")&&a.d(t,{useParams:function(){return s.useParams}}),a.o(s,"usePathname")&&a.d(t,{usePathname:function(){return s.usePathname}}),a.o(s,"useRouter")&&a.d(t,{useRouter:function(){return s.useRouter}}),a.o(s,"useSearchParams")&&a.d(t,{useSearchParams:function(){return s.useSearchParams}})},23327:(e,t,a)=>{"use strict";a.d(t,{A:()=>s});let s=(0,a(71847).A)("Info",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]])},24033:(e,t,a)=>{"use strict";a.d(t,{A:()=>s});let s=(0,a(71847).A)("ChevronDown",[["path",{d:"m6 9 6 6 6-6",key:"qrunsl"}]])},35626:(e,t,a)=>{"use strict";a.d(t,{A:()=>s});let s=(0,a(71847).A)("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]])},37586:(e,t,a)=>{"use strict";a.d(t,{A:()=>s});let s=(0,a(71847).A)("MessageSquare",[["path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z",key:"1lielz"}]])},61362:(e,t,a)=>{"use strict";a.d(t,{A:()=>s});let s=(0,a(71847).A)("CircleCheck",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]])},65229:(e,t,a)=>{"use strict";a.d(t,{A:()=>s});let s=(0,a(71847).A)("X",[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]])},71847:(e,t,a)=>{"use strict";a.d(t,{A:()=>c});var s=a(12115);let r=function(){for(var e=arguments.length,t=Array(e),a=0;a<e;a++)t[a]=arguments[a];return t.filter((e,t,a)=>!!e&&""!==e.trim()&&a.indexOf(e)===t).join(" ").trim()};var l={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};let n=(0,s.forwardRef)((e,t)=>{let{color:a="currentColor",size:n=24,strokeWidth:c=2,absoluteStrokeWidth:i,className:o="",children:d,iconNode:m,...u}=e;return(0,s.createElement)("svg",{ref:t,...l,width:n,height:n,stroke:a,strokeWidth:i?24*Number(c)/Number(n):c,className:r("lucide",o),...u},[...m.map(e=>{let[t,a]=e;return(0,s.createElement)(t,a)}),...Array.isArray(d)?d:[d]])}),c=(e,t)=>{let a=(0,s.forwardRef)((a,l)=>{let{className:c,...i}=a;return(0,s.createElement)(n,{ref:l,iconNode:t,className:r("lucide-".concat(e.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase()),c),...i})});return a.displayName="".concat(e),a}},76968:(e,t,a)=>{Promise.resolve().then(a.bind(a,276))},78874:(e,t,a)=>{"use strict";a.d(t,{A:()=>s});let s=(0,a(71847).A)("CircleX",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]])},93014:(e,t,a)=>{"use strict";a.d(t,{ToastProvider:()=>x,d:()=>d});var s=a(95155),r=a(12115),l=a(61362),n=a(78874),c=a(23327),i=a(65229);let o=(0,r.createContext)(null);function d(){let e=(0,r.useContext)(o);if(!e)throw Error("useToast must be used inside <ToastProvider>");return e}let m={success:(0,s.jsx)(l.A,{className:"h-4 w-4 shrink-0",style:{color:"#22c55e"}}),error:(0,s.jsx)(n.A,{className:"h-4 w-4 shrink-0",style:{color:"#ef4444"}}),info:(0,s.jsx)(c.A,{className:"h-4 w-4 shrink-0",style:{color:"var(--accent)"}})},u={success:"rgba(34,197,94,0.3)",error:"rgba(239,68,68,0.3)",info:"rgba(26,143,163,0.3)"};function x(e){let{children:t}=e,[a,l]=(0,r.useState)([]),n=(0,r.useRef)({}),c=(0,r.useCallback)(e=>{l(t=>t.filter(t=>t.id!==e)),n.current[e]&&(clearTimeout(n.current[e]),delete n.current[e])},[]),d=(0,r.useCallback)((e,t)=>{let a=Math.random().toString(36).slice(2);l(s=>[...s.slice(-4),{id:a,type:e,message:t}]),n.current[a]=setTimeout(()=>c(a),3500)},[c]),x=(0,r.useMemo)(()=>({success:e=>d("success",e),error:e=>d("error",e),info:e=>d("info",e)}),[d]);return(0,s.jsxs)(o.Provider,{value:x,children:[t,(0,s.jsx)("div",{"aria-live":"polite",className:"fixed bottom-5 right-4 z-[9999] flex flex-col gap-2 items-end pointer-events-none",style:{maxWidth:"min(380px, calc(100vw - 2rem))"},children:a.map(e=>(0,s.jsxs)("div",{role:"alert",className:"pointer-events-auto flex items-start gap-3 rounded-xl px-4 py-3 text-sm shadow-lg animate-toast-in",style:{background:"var(--surface-3)",border:"1px solid ".concat(u[e.type]),backdropFilter:"blur(12px)",WebkitBackdropFilter:"blur(12px)",color:"var(--text)",minWidth:"240px"},children:[m[e.type],(0,s.jsx)("p",{className:"flex-1 leading-snug",style:{color:"var(--text)"},children:e.message}),(0,s.jsx)("button",{onClick:()=>c(e.id),className:"shrink-0 mt-0.5 opacity-50 hover:opacity-100 transition-opacity","aria-label":"Fechar",children:(0,s.jsx)(i.A,{className:"h-3.5 w-3.5"})})]},e.id))}),(0,s.jsx)("style",{children:"\n        @keyframes toast-in {\n          from { opacity: 0; transform: translateY(8px) scale(0.96); }\n          to   { opacity: 1; transform: translateY(0) scale(1); }\n        }\n        .animate-toast-in { animation: toast-in 0.18s ease-out forwards; }\n      "})]})}},95740:(e,t,a)=>{"use strict";a.d(t,{A:()=>s});let s=(0,a(71847).A)("Sparkles",[["path",{d:"M9.937 15.5A2 2 0 0 0 8.5 14.063l-6.135-1.582a.5.5 0 0 1 0-.962L8.5 9.936A2 2 0 0 0 9.937 8.5l1.582-6.135a.5.5 0 0 1 .963 0L14.063 8.5A2 2 0 0 0 15.5 9.937l6.135 1.581a.5.5 0 0 1 0 .964L15.5 14.063a2 2 0 0 0-1.437 1.437l-1.582 6.135a.5.5 0 0 1-.963 0z",key:"4pj2yx"}],["path",{d:"M20 3v4",key:"1olli1"}],["path",{d:"M22 5h-4",key:"1gvqau"}],["path",{d:"M4 17v2",key:"vumght"}],["path",{d:"M5 18H3",key:"zchphs"}]])},99051:(e,t,a)=>{"use strict";a.d(t,{A:()=>s});let s=(0,a(71847).A)("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]])}},e=>{e.O(0,[8441,1255,7358],()=>e(e.s=76968)),_N_E=e.O()}]);