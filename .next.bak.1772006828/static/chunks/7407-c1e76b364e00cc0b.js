(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7407],{39498:(e,t,a)=>{"use strict";a.d(t,{default:()=>m});var s=a(95155),l=a(12115),r=a(69434),i=a(62890),n=a(64269),c=a(91040),o=a(63479),d=a(34416);let u={crew:"Crew",equipamento:"Equipamento",pos_producao:"P\xf3s",despesas:"Despesas",outro:"Outros"};function p(e){let t=(null!=e?e:"").toLowerCase();return"rascunho"===t||"draft"===t?"Rascunho":"enviado"===t||"sent"===t?"Enviado":"aprovado"===t||"approved"===t?"Aprovado":"cancelado"===t||"cancelled"===t?"Cancelado":"arquivado"===t||"archived"===t?"Arquivado":"done"===t?"Done":"todo"===t?"Todo":e||"Ativo"}function m(){let{dashboardMode:e,setDashboardMode:t}=(0,o.D)(),[a,m]=(0,l.useState)(!0),[h,x]=(0,l.useState)(null),[g,v]=(0,l.useState)(""),[j,b]=(0,l.useState)([]),[f,N]=(0,l.useState)([]),[w,_]=(0,l.useState)([]),[S,y]=(0,l.useState)(0),[k,C]=(0,l.useState)(0),[A,D]=(0,l.useState)(0),[E,M]=(0,l.useState)(0),[L,P]=(0,l.useState)(0),[T,H]=(0,l.useState)("Daniel"),O=(0,l.useCallback)(async()=>{m(!0),x(null);try{var e,t,a,s,l,r,n,c,o,d,u,p,h,g,v,j,f;let m=(0,i.U)(),{data:x}=await m.auth.getUser(),w=x.user,S=null!=(n=null==w||null==(t=w.email)||null==(e=t.split("@")[0])?void 0:e.split(".")[0])?n:"Daniel",k=null!=(o=null!=(c=null==w||null==(a=w.user_metadata)?void 0:a.first_name)?c:null==w||null==(r=w.user_metadata)||null==(l=r.name)||null==(s=l.split(" "))?void 0:s[0])?o:S;H(k.charAt(0).toUpperCase()+k.slice(1));let[A,E,L,T,O,F,q,z]=await Promise.all([m.from("projects").select("id, project_name, client_name, status, created_at, calc, inputs").is("deleted_at",null).order("created_at",{ascending:!1}).limit(120),m.from("tasks").select("id, title, status, due_date, created_at").is("deleted_at",null).order("created_at",{ascending:!1}).limit(120),m.from("clients").select("id",{count:"exact",head:!0}).is("deleted_at",null),m.from("conversations").select("id",{count:"exact",head:!0}),m.from("call_sheets").select("id",{count:"exact",head:!0}),m.from("call_sheets").select("id, created_at").order("created_at",{ascending:!1}).limit(8),m.from("logistics_routes").select("id",{count:"exact",head:!0}),m.from("weather_cache").select("id",{count:"exact",head:!0})]);if(A.error)throw Error(A.error.message);if(E.error)throw Error(E.error.message);if(L.error)throw Error(L.error.message);b(null!=(d=A.data)?d:[]),N(null!=(u=E.data)?u:[]),_(null!=(p=F.data)?p:[]),y(null!=(h=L.count)?h:0),C(null!=(g=T.count)?g:0),D(null!=(v=O.count)?v:0),M(null!=(j=q.count)?j:0),P(null!=(f=z.count)?f:0)}catch(e){x(e instanceof Error?e.message:"Erro ao carregar dashboard")}finally{m(!1)}},[]);(0,l.useEffect)(()=>{O()},[O]);let F=Date.now(),q=F-6048e5,z=(0,l.useMemo)(()=>{let e=j.length,t=j.filter(e=>new Date(e.created_at).getTime()>=q).length,a=f.filter(e=>"done"!==e.status).length,s=j.filter(e=>["enviado","sent"].includes((e.status||"").toLowerCase())).length,l=j.map(e=>{var t,a;return Number(null!=(a=null==(t=e.calc)?void 0:t.margem_real_pct)?a:0)}).filter(e=>Number.isFinite(e)&&e>0);return{activeProjects:e,weeklyBudgets:t,leads:S,openTasks:a,pendingApprovals:s,avgMargin:l.length>0?l.reduce((e,t)=>e+t,0)/l.length:0}},[j,f,S,q]),R=(0,l.useMemo)(()=>{let e=f.filter(e=>"done"!==e.status&&e.due_date).sort((e,t)=>{var a,s;return new Date(null!=(a=e.due_date)?a:"").getTime()-new Date(null!=(s=t.due_date)?s:"").getTime()}).slice(0,6).map((e,t)=>{var a;let s=new Date(null!=(a=e.due_date)?a:""),l=s.toLocaleTimeString("pt-PT",{hour:"2-digit",minute:"2-digit"});return{id:e.id,time:l,title:e.title,subtitle:"Deadline \xb7 ".concat((0,n.kz)(s.toISOString())),startsAt:s.toISOString(),calendarHref:"/api/calendar/event.ics?source=task&id=".concat(e.id),active:0===t}});if(e.length>0)return e;let t=new Date;return[{id:"ph-1",time:"09:00",title:"Kickoff Produ\xe7\xe3o",subtitle:"Com equipa e cliente",active:!0},{id:"ph-2",time:"11:00",title:"Revis\xe3o de Budget",subtitle:"Guardrails + margem"},{id:"ph-3",time:"14:30",title:"Follow-up Leads",subtitle:"Pipeline comercial"},{id:"ph-4",time:"16:00",title:"Feedback Entregas",subtitle:"Aprova\xe7\xf5es pendentes"}].map(e=>{let[a,s]=e.time.split(":").map(Number),l=new Date(t);return l.setHours(a,s,0,0),{...e,startsAt:l.toISOString(),calendarHref:((e,t,a)=>{let s=new Date(t.getTime()+27e5),l=new URLSearchParams({title:e,start:t.toISOString(),end:s.toISOString(),description:a});return"/api/calendar/event.ics?".concat(l.toString())})(e.title,l,e.subtitle)}})},[f]),I=(0,l.useMemo)(()=>j.slice(0,8).map(e=>{var t,a;return{id:e.id,name:e.project_name,owner:e.client_name||"Sem cliente",status:p(e.status),value:Number(null!=(a=null==(t=e.calc)?void 0:t.preco_recomendado)?a:0)}}),[j]),G=(0,l.useMemo)(()=>{let e=[];for(let r of j.slice(0,12)){var t,a,s,l;let i=Number(null!=(s=null==(t=r.inputs)?void 0:t.margem_minima_pct)?s:0),n=Number(null!=(l=null==(a=r.calc)?void 0:a.margem_real_pct)?l:0);if(i>0&&n>0&&n<i&&e.push({level:"warn",text:"".concat(r.project_name,": margem ").concat(n.toFixed(1),"% abaixo do m\xednimo ").concat(i,"%")}),["enviado","sent"].includes((r.status||"").toLowerCase())){let t=(F-new Date(r.created_at).getTime())/864e5;t>7&&e.push({level:"warn",text:"".concat(r.project_name,": enviado h\xe1 ").concat(Math.round(t)," dias sem decis\xe3o")})}}return z.openTasks>18&&e.push({level:"warn",text:"".concat(z.openTasks," tarefas em aberto â€” risco de atraso operacional")}),0===e.length&&e.push({level:"ok",text:"Margens e pipeline est\xe3o dentro do esperado."}),e},[j,F,z.openTasks]),U=(0,l.useMemo)(()=>{let e=[];for(let t=5;t>=0;t-=1){let a=new Date;a.setMonth(a.getMonth()-t,1);let s=a.toLocaleDateString("en-US",{month:"short"}),l=j.filter(e=>{let t=new Date(e.created_at);return t.getFullYear()===a.getFullYear()&&t.getMonth()===a.getMonth()}).reduce((e,t)=>{var a,s;return e+Number(null!=(s=null==(a=t.calc)?void 0:a.preco_recomendado)?s:0)},0);e.push({month:s,value:l})}return e},[j]),K=(0,l.useMemo)(()=>{let e=new Map;for(let n of j.slice(0,30)){var t,a,s,l,r,i;for(let c of null!=(a=null==(t=n.inputs)?void 0:t.itens)?a:[]){let t=null!=(s=c.categoria)?s:"outro",a=Number(null!=(l=c.quantidade)?l:0)*Number(null!=(r=c.preco_unitario)?r:0);e.set(t,(null!=(i=e.get(t))?i:0)+a)}}let n=[...e.entries()].filter(e=>{let[,t]=e;return t>0}).map(e=>{var t;let[a,s]=e;return{name:null!=(t=u[a])?t:a,value:s}}).sort((e,t)=>t.value-e.value).slice(0,4);return n.length>0?n:[{name:"Crew",value:4200},{name:"Equipamento",value:2800},{name:"P\xf3s",value:1700},{name:"Despesas",value:900}]},[j]),$=(0,l.useMemo)(()=>{let e=new Map;for(let a of j){var t;let s=p(a.status);e.set(s,(null!=(t=e.get(s))?t:0)+1)}return[...e.entries()].sort((e,t)=>t[1]-e[1]).slice(0,5).map((e,t)=>{let[a,s]=e;return{id:"".concat(a,"-").concat(t),title:a,subtitle:"".concat(s," projetos"),status:s>5?"Hot":"Normal"}})},[j]),V=(0,l.useMemo)(()=>{let e=g.trim().toLowerCase(),t=j.map(e=>({id:e.id,title:e.project_name,subtitle:"".concat(e.client_name||"Sem cliente"," \xb7 ").concat((0,n.kz)(e.created_at)),status:p(e.status),ctaHref:"/app/projects/".concat(e.id),ctaLabel:"Open"})),a=f.map(e=>({id:"task-".concat(e.id),title:e.title,subtitle:e.due_date?"Task \xb7 ".concat((0,n.kz)(e.due_date)):"Task sem deadline",status:p(e.status),ctaHref:"/app/tasks",ctaLabel:"Reply"})),s=[...t.slice(0,4),...a.slice(0,3)];return e?s.filter(t=>{var a;return t.title.toLowerCase().includes(e)||(null!=(a=t.subtitle)?a:"").toLowerCase().includes(e)}):s},[j,g,f]),Y=(0,l.useMemo)(()=>{let e=f.filter(e=>"done"!==e.status).sort((e,t)=>(e.due_date?new Date(e.due_date).getTime():Number.MAX_SAFE_INTEGER)-(t.due_date?new Date(t.due_date).getTime():Number.MAX_SAFE_INTEGER)).slice(0,5);return 0===e.length?[{id:"placeholder",title:"Sem tarefas cr\xedticas",subtitle:"A equipa est\xe1 em dia.",status:"OK"}]:e.map(e=>({id:e.id,title:e.title,subtitle:e.due_date?"Prazo ".concat((0,n.kz)(e.due_date)):"Sem prazo",status:p(e.status),ctaHref:"/app/tasks",ctaLabel:"Ver"}))},[f]),W=(0,l.useMemo)(()=>0===w.length?[{id:"empty-calls",title:"Sem call sheets recentes",subtitle:"Cria um call sheet para a opera\xe7\xe3o."}]:w.map((e,t)=>({id:e.id,title:"Call Sheet #".concat(String(t+1).padStart(2,"0")),subtitle:"Atualizado ".concat((0,n.kz)(e.created_at)),ctaHref:"/app/callsheets",ctaLabel:"Abrir"})),[w]),B=(0,l.useMemo)(()=>[{id:"routes",title:"Rotas log\xedsticas",subtitle:"".concat(E," registos"),status:E>0?"OK":"Setup",ctaHref:"/app/logistics",ctaLabel:"Ver"},{id:"weather",title:"Weather cache",subtitle:"".concat(L," entradas"),status:L>10?"Fresh":"Low",ctaHref:"/app/weather",ctaLabel:"Abrir"},{id:"approvals",title:"Aprova\xe7\xf5es pendentes",subtitle:"".concat(z.pendingApprovals," projetos"),status:z.pendingApprovals>0?"Warn":"OK",ctaHref:"/app/projects",ctaLabel:"Rever"},{id:"inbox",title:"Conversas ativas",subtitle:"".concat(k," threads"),status:k>0?"Live":"Empty",ctaHref:"/app/inbox",ctaLabel:"Inbox"}],[k,E,z.pendingApprovals,L]),X=(0,s.jsxs)("div",{className:"flex flex-wrap items-end justify-between gap-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"text-[0.72rem] uppercase tracking-[0.12em]",style:{color:"var(--text-3)"},children:"ceo"===e?"CEO Dashboard":"Empresa Dashboard"}),(0,s.jsxs)("h2",{className:"mt-1.5 text-[2rem] font-[540] tracking-[-0.03em]",style:{color:"var(--text)"},children:["Hi, ",T,"!"]}),(0,s.jsx)("p",{className:"text-sm",style:{color:"var(--text-2)"},children:"ceo"===e?"Vis\xe3o premium, calma e estrat\xe9gica para decis\xf5es de neg\xf3cio.":"Vista operacional para execu\xe7\xe3o di\xe1ria e controlo de produ\xe7\xe3o."})]}),(0,s.jsxs)("div",{className:"flex flex-wrap items-center gap-2.5",children:[(0,s.jsx)(d.ke,{value:g,onChange:v,placeholder:"Pesquisar updates"}),(0,s.jsx)(d.Er,{mode:e,onChange:t})]})]});return a?(0,s.jsx)(d.O2,{}):h?(0,s.jsx)("div",{className:"card",children:(0,s.jsx)(c.pp,{title:"Erro ao carregar dashboard",description:h,action:(0,s.jsx)(c.KF,{className:"px-4 py-2 text-xs",onClick:()=>void O(),children:"Retry"})})}):(0,s.jsx)(r.P.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},transition:{duration:.32,ease:"easeOut"},className:"space-y-6",children:(0,s.jsx)(d.Rd,{header:X,children:"ceo"===e?(0,s.jsxs)("div",{className:"grid gap-6 lg:grid-cols-2 xl:grid-cols-12",children:[(0,s.jsx)("div",{className:"lg:col-span-1 xl:col-span-8",children:(0,s.jsx)(d.nz,{greeting:"Hi, ".concat(T,"!"),subtitle:"Resumo de hoje com foco em pipeline, risco e execu\xe7\xe3o sem ru\xeddo operacional.",metrics:[{id:"projects",label:"Or\xe7amentos ativos",value:String(z.activeProjects),hint:"".concat(z.weeklyBudgets," novos esta semana"),tone:"blue"},{id:"approvals",label:"Aprova\xe7\xf5es pendentes",value:String(z.pendingApprovals),hint:"Aguardam resposta",tone:"yellow"},{id:"critical",label:"Tarefas cr\xedticas",value:String(z.openTasks),hint:"Necessitam follow-up",tone:"lilac"},{id:"leads",label:"Leads quentes",value:String(z.leads),hint:"Clientes ativos",tone:"mint"}],primaryCta:{href:"/app/projects/new",label:"Novo Projeto"},secondaryCta:{href:"/app/projects/new",label:"Novo Or\xe7amento"}})}),(0,s.jsx)("div",{className:"lg:col-span-1 xl:col-span-4",children:(0,s.jsx)(d.Lz,{events:R,feedHref:"/api/calendar/feed.ics"})}),(0,s.jsx)("div",{className:"lg:col-span-1 xl:col-span-4",children:(0,s.jsx)(d.do,{title:"Forecast",subtitle:"Receita projetada",children:(0,s.jsx)(d.G1,{data:U})})}),(0,s.jsx)("div",{className:"lg:col-span-1 xl:col-span-3",children:(0,s.jsx)(d.$_,{title:"Pipeline",subtitle:"Hot / Follow-up / Waiting",rows:$})}),(0,s.jsx)("div",{className:"lg:col-span-2 xl:col-span-5",children:(0,s.jsx)(d.$_,{title:"Inbox / Updates",subtitle:"5 itens mais recentes",rows:V})}),(0,s.jsx)("div",{className:"lg:col-span-1 xl:col-span-7",children:(0,s.jsx)(d.wq,{items:R.slice(0,5)})}),(0,s.jsx)("div",{className:"lg:col-span-1 xl:col-span-5",children:(0,s.jsx)(d.Zg,{alerts:G})}),(0,s.jsx)("div",{className:"lg:col-span-1 xl:col-span-6",children:(0,s.jsx)(d.do,{title:"Composi\xe7\xe3o de Custos",subtitle:"Distribui\xe7\xe3o por categoria",children:(0,s.jsx)(d.Gk,{data:K})})}),(0,s.jsx)("div",{className:"lg:col-span-1 xl:col-span-6",children:(0,s.jsx)(d.$_,{title:"Tarefas do dia",subtitle:"Top 5 por prioridade de prazo",rows:Y})})]}):(0,s.jsxs)("div",{className:"space-y-6",children:[(0,s.jsxs)("div",{className:"grid gap-4 sm:grid-cols-2 xl:grid-cols-4",children:[(0,s.jsx)(d.Sl,{label:"Projetos ativos",value:String(z.activeProjects),hint:"Opera\xe7\xe3o em curso"}),(0,s.jsx)(d.Sl,{label:"Entregas semana",value:String(A),hint:"Call sheets e entregas"}),(0,s.jsx)(d.Sl,{label:"Backlog",value:String(z.openTasks),hint:"Tarefas abertas"}),(0,s.jsx)(d.Sl,{label:"Margem m\xe9dia",value:"".concat(z.avgMargin.toFixed(1),"%"),hint:"Projetos recentes"})]}),(0,s.jsxs)("div",{className:"grid gap-6 lg:grid-cols-2 xl:grid-cols-12",children:[(0,s.jsx)("div",{className:"lg:col-span-1 xl:col-span-4",children:(0,s.jsx)(d.$_,{title:"Callsheets recentes",subtitle:"\xdaltimas opera\xe7\xf5es",rows:W})}),(0,s.jsx)("div",{className:"lg:col-span-1 xl:col-span-4",children:(0,s.jsx)(d.$_,{title:"Log\xedstica / Weather",subtitle:"Estado t\xe9cnico",rows:B})}),(0,s.jsx)("div",{className:"lg:col-span-2 xl:col-span-4",children:(0,s.jsx)(d.Zg,{alerts:G})}),(0,s.jsx)("div",{className:"lg:col-span-2 xl:col-span-7",children:(0,s.jsx)(d.wF,{rows:I})}),(0,s.jsx)("div",{className:"lg:col-span-1 xl:col-span-5",children:(0,s.jsx)(d.do,{title:"Forecast operacional",subtitle:"Volume mensal",children:(0,s.jsx)(d.G1,{data:U})})}),(0,s.jsx)("div",{className:"lg:col-span-1 xl:col-span-5",children:(0,s.jsx)(d.do,{title:"Mix de custos",subtitle:"Custos dos projetos ativos",children:(0,s.jsx)(d.Gk,{data:K})})}),(0,s.jsx)("div",{className:"lg:col-span-1 xl:col-span-7",children:(0,s.jsx)(d.$_,{title:"Aprova\xe7\xf5es e conversas",subtitle:"Follow-up em progresso",rows:V})})]})]})})})}},77407:(e,t,a)=>{Promise.resolve().then(a.bind(a,39498))},79051:(e,t,a)=>{"use strict";a.d(t,{A:()=>s});let s=(0,a(71847).A)("Clock3",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["polyline",{points:"12 6 12 12 16.5 12",key:"1aq6pp"}]])},91040:(e,t,a)=>{"use strict";a.d(t,{A:()=>h,KF:()=>p,O3:()=>m,ab:()=>u,do:()=>x,pp:()=>g,u4:()=>v});var s=a(95155),l=a(69434),r=a(41407),i=a(10383),n=a(79051),c=a(86651),o=a(64269),d=a(4874);function u(e){let{className:t,children:a,active:r=!1}=e,i=(0,d.Y3)();return(0,s.jsx)(l.P.span,{className:(0,o.cn)("pill",r&&"pill-active",t),...i?{whileHover:{y:-1},transition:d.bm.smooth}:{},children:a})}function p(e){let{className:t,children:a,variant:r="secondary",...i}=e,n=(0,d.Pm)();return(0,s.jsx)(l.P.button,{className:(0,o.cn)("pill-btn","primary"===r?"pill-btn-primary":"pill-btn-secondary",t),...(0,d.HY)({enabled:n}),...i,children:a})}function m(e){let{className:t,...a}=e;return(0,s.jsx)("input",{className:(0,o.cn)("pill-input",t),...a})}function h(e){let{className:t,avatars:a=[]}=e,c=(0,r.I)(),u=new Date().toLocaleDateString("pt-PT",{weekday:"long",day:"2-digit",month:"long"});return(0,s.jsx)(l.P.div,{initial:!c&&"initial",animate:c?void 0:"animate",variants:{initial:{opacity:0,y:-8},animate:{opacity:1,y:0}},transition:d.bm.page,className:(0,o.cn)("top-schedule-bar p-4 md:p-5",t),children:(0,s.jsxs)("div",{className:"flex flex-wrap items-center gap-3 md:gap-5",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2.5",children:[(0,s.jsx)("span",{className:"icon-btn","aria-hidden":!0,children:(0,s.jsx)(i.A,{className:"h-4 w-4"})}),(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"text-xs uppercase tracking-[0.08em]",style:{color:"var(--muted)"},children:"Schedule"}),(0,s.jsx)("p",{className:"text-sm font-semibold capitalize",style:{color:"var(--text)"},children:u})]})]}),(0,s.jsx)("div",{className:"flex flex-1 flex-wrap items-center gap-2",children:["09:00","11:30","14:00","16:30"].map(e=>(0,s.jsxs)("span",{className:"pill inline-flex items-center gap-1.5",children:[(0,s.jsx)(n.A,{className:"h-3.5 w-3.5"}),e]},e))}),(0,s.jsx)("div",{className:"flex items-center",children:a.length>0?(0,s.jsx)("div",{className:"-space-x-2",children:a.slice(0,4).map(e=>(0,s.jsx)("span",{className:"inline-flex h-8 w-8 items-center justify-center rounded-full border text-xs font-semibold",style:{background:"var(--surface-2)",borderColor:"var(--border-soft)",color:"var(--text)"},children:e.trim().slice(0,1).toUpperCase()},e))}):(0,s.jsx)("span",{className:"pill",children:"Sem equipa atribuida"})})]})})}function x(e){let{className:t,title:a,action:r,children:i}=e,n=(0,d.Y3)();return(0,s.jsxs)(l.P.section,{className:(0,o.cn)("chart-card card-hover",t),...(0,d.XC)(n),children:[(0,s.jsxs)("header",{className:"mb-4 flex items-center justify-between gap-3",children:[(0,s.jsx)("h3",{className:"text-sm font-semibold",style:{color:"var(--text)"},children:a}),r]}),i]})}function g(e){let{className:t,title:a,description:l,action:r}=e;return(0,s.jsxs)("div",{className:(0,o.cn)("empty-state empty-state-premium",t),children:[(0,s.jsx)(c.A,{className:"empty-icon"}),(0,s.jsx)("p",{className:"empty-title",children:a}),l?(0,s.jsx)("p",{className:"empty-desc",children:l}):null,r]})}function v(e){let{className:t}=e;return(0,s.jsx)(l.P.div,{initial:{opacity:.65},animate:{opacity:1},transition:{duration:.45,ease:"easeOut"},className:(0,o.cn)("skeleton-card h-28",t)})}}}]);